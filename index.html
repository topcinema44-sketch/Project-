<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NUSA TASK</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Monetag SDK (Rewarded & Popup untuk tombol Menghasilkan) -->
<script src='//libtl.com/sdk.js' data-zone='9779635' data-sdk='show_9779635'></script>

<!-- Adila / WP Ad Manager (script obfuscated penuh â€“ sesuai permintaan) -->
<script data-cfasync='false'>
function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=368971,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}
</script>

<style>
  :root{
    --bg:#0e0f12;--card:#15171d;--text:#eef2f7;--muted:#9aa0a6;
    --accent:#00e676;--x1:#29b6f6;--x2:#ff8f00;--danger:#ff1744;--r:18px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:Poppins,system-ui,sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center}
  /* Splash */
  #splash{position:fixed;inset:0;display:flex;flex-direction:column;gap:18px;align-items:center;justify-content:center;background:var(--bg);z-index:9999}
  #splash .logo{font-weight:800;font-size:60px;letter-spacing:3px;color:var(--accent)}
  .track{width:280px;height:8px;background:#1d2026;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(135deg,#00e676,#00c853);animation:grow 2.6s ease forwards}
  @keyframes grow{to{width:100%}}
  /* Auth modal */
  #auth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9998}
  .auth-card{width:min(420px,92%);background:var(--card);border-radius:22px;padding:22px;box-shadow:0 10px 40px rgba(0,0,0,.45)}
  .auth-card h3{margin-bottom:10px}
  .field{display:flex;flex-direction:column;margin:10px 0}
  .field label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .field input{background:#0f1115;border:1px solid #232833;color:var(--text);padding:12px;border-radius:14px;outline:none}
  .auth-actions{display:flex;gap:10px;margin-top:12px}
  .btn{border:none;border-radius:16px;padding:14px;font-weight:700;color:#111;cursor:pointer}
  .btn-primary{background:var(--accent)}
  .btn-ghost{background:#222a35;color:#fff}
  /* App */
  #app{display:none;width:100%;max-width:440px;padding:22px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .brand{font-weight:800;color:var(--accent);font-size:22px}
  .profile{display:flex;align-items:center;gap:10px}
  .avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#111;display:grid;place-items:center;font-weight:800}
  #emailDisplay{font-size:13px;color:var(--muted)}
  #saldo{margin:12px 0 18px;font-weight:800;font-size:18px;color:var(--accent)}
  .card{background:var(--card);padding:16px;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .cta{width:100%;padding:16px;border:none;border-radius:18px;font-weight:800;color:#111;margin:12px 0 8px;cursor:pointer;transition:.2s transform,.2s opacity}
  .cta:hover:not(:disabled){transform:translateY(-2px);opacity:.95}
  .cta:disabled{opacity:.5;filter:grayscale(.7);cursor:not-allowed}
  .earn{background:linear-gradient(135deg,#00e676,#00c853)}
  .x1{background:linear-gradient(135deg,#29b6f6,#0288d1);color:#fff}
  .x2{background:linear-gradient(135deg,#ff8f00,#ff6f00);color:#111}
  .progress{height:8px;background:#1d2026;border-radius:999px;overflow:hidden}
  .bar2{height:100%;width:0;background:var(--accent);transition:width .35s}
  .bar-x1{background:var(--x1)}
  .bar-x2{background:var(--x2)}
  .sub{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin:6px 0 10px}
  /* Bonus area (render iklan) */
  .bonusArea{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .bannerBox{width:100%;min-height:250px;background:#0f1115;border:1px dashed #2a3140;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#5e6b80}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="logo">NT</div>
  <div class="track"><div class="bar"></div></div>
  <div style="color:#9aa0a6;font-size:13px">Menyiapkan NUSA TASKâ€¦</div>
</div>

<!-- Auth -->
<div id="auth" style="display:none">
  <div class="auth-card">
    <h3>Masuk / Daftar</h3>
    <div class="field">
      <label>Email</label>
      <input id="email" type="email" placeholder="kamu@mail.com" autocomplete="email">
    </div>
    <div class="field">
      <label>Password</label>
      <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
    <div class="auth-actions">
      <button id="btnLogin" class="btn btn-primary" style="flex:1">Masuk</button>
      <button id="btnRegister" class="btn btn-ghost" style="flex:1">Daftar</button>
    </div>
  </div>
</div>

<!-- App -->
<div id="app">
  <header>
    <div class="brand">NUSA TASK</div>
    <div class="profile">
      <div class="avatar">U</div>
      <div>
        <div id="emailDisplay">â€”</div>
      </div>
    </div>
  </header>

  <div id="saldo" class="card">Rp 0</div>

  <div class="card">
    <!-- Earn -->
    <button id="btnEarn" class="cta earn">Menghasilkan (Rp 20.000)</button>
    <div class="progress"><div id="pEarn" class="bar2"></div></div>
    <div class="sub"><span id="cEarn">0 / 20</span><span id="cdEarn">siap</span></div>

    <!-- Xstra Bonus 1 -->
    <button id="btnX1" class="cta x1">Xstra Bonus 1 (Rp 10.000)</button>
    <div class="progress"><div id="pX1" class="bar2 bar-x1"></div></div>
    <div class="sub"><span id="cX1">0 / 10</span><span id="cdX1">siap</span></div>
    <div id="areaX1" class="bonusArea"></div>

    <!-- Xstra Bonus 2 -->
    <button id="btnX2" class="cta x2">Xstra Bonus 2 (Rp 10.000)</button>
    <div class="progress"><div id="pX2" class="bar2 bar-x2"></div></div>
    <div class="sub"><span id="cX2">0 / 10</span><span id="cdX2">siap</span></div>
    <div id="areaX2" class="bonusArea"></div>
  </div>
</div>

<!-- Firebase (v9 modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getDatabase, ref, get, set, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

  // ==== CONFIG FIREBASE ====
  const firebaseConfig = {
    apiKey: "AIzaSyBpKWInCFVA_4-qyCT4QvW86e1uVf5YtEA",
    authDomain: "nusataskproject-872a1.firebaseapp.com",
    databaseURL: "https://nusataskproject-872a1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nusataskproject-872a1",
    storageBucket: "nusataskproject-872a1.firebasestorage.app",
    messagingSenderId: "669134125045",
    appId: "1:669134125045:web:840b60f2f987aba8fcd2bc",
    measurementId: "G-MX4259KDTG"
  };

  const appFB = initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getDatabase(appFB);

  // ====== UI refs ======
  const splash = document.getElementById('splash');
  const authWrap = document.getElementById('auth');
  const app = document.getElementById('app');
  const emailEl = document.getElementById('email');
  const passEl  = document.getElementById('password');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');

  const emailDisplay = document.getElementById('emailDisplay');
  const saldoEl = document.getElementById('saldo');

  const btnEarn = document.getElementById('btnEarn');
  const btnX1 = document.getElementById('btnX1');
  const btnX2 = document.getElementById('btnX2');

  const pEarn = document.getElementById('pEarn');
  const pX1 = document.getElementById('pX1');
  const pX2 = document.getElementById('pX2');

  const cEarn = document.getElementById('cEarn');
  const cX1 = document.getElementById('cX1');
  const cX2 = document.getElementById('cX2');

  const cdEarn = document.getElementById('cdEarn');
  const cdX1 = document.getElementById('cdX1');
  const cdX2 = document.getElementById('cdX2');

  const areaX1 = document.getElementById('areaX1');
  const areaX2 = document.getElementById('areaX2');

  // ====== Params ======
  const LIMIT_EARN = 20;
  const LIMIT_X = 10;
  const REWARD_EARN = 20000;
  const REWARD_X = 10000;
  const COOLDOWN_MS = 3 * 60 * 1000; // 3 menit
  const AD_TIMEOUT = 15000; // 15 detik guard supaya tidak stuck

  // server time (anti manipulasi jam lokal)
  let serverOffset = 0;
  onValue(ref(db, ".info/serverTimeOffset"), (snap)=>{ serverOffset = snap.val()||0; });
  const nowServer = () => Date.now() + serverOffset;

  // Splash â†’ show auth/app
  setTimeout(()=>{ splash.style.display="none"; }, 1400);

  // ==== AUTH ====
  btnLogin.onclick = async ()=>{
    const email = emailEl.value.trim(), pass = passEl.value;
    if(!email || !pass) { toast("Isi email & password"); return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){ toast("Login gagal: " + (e?.message||"")); }
  };
  btnRegister.onclick = async ()=>{
    const email = emailEl.value.trim(), pass = passEl.value;
    if(!email || !pass) { toast("Isi email & password"); return; }
    if(pass.length < 6){ toast("Password minimal 6 karakter"); return; }
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await set(ref(db, "users/"+cred.user.uid), {
        email, balance:0,
        earnToday:0, bonus1Today:0, bonus2Today:0,
        lastEarn:0, lastBonus1:0, lastBonus2:0,
        lastReset:""
      });
    }catch(e){ toast("Daftar gagal: " + (e?.message||"")); }
  };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      authWrap.style.display = "none";
      app.style.display = "block";
      emailDisplay.textContent = user.email || "â€”";
      attachUserListeners(user.uid);
      scheduleDailyReset(user.uid);
    }else{
      authWrap.style.display = "flex";
      app.style.display = "none";
    }
  });

  // ==== Listeners ====
  function attachUserListeners(uid){
    const uRef = ref(db, "users/"+uid);
    onValue(uRef, (snap)=>{
      if(!snap.exists()) return;
      const d = snap.val();

      // saldo
      saldoEl.textContent = "Rp " + (d.balance||0).toLocaleString("id-ID");

      // counters
      const e = d.earnToday|0, b1 = d.bonus1Today|0, b2 = d.bonus2Today|0;
      cEarn.textContent = `${e} / ${LIMIT_EARN}`;
      cX1.textContent   = `${b1} / ${LIMIT_X}`;
      cX2.textContent   = `${b2} / ${LIMIT_X}`;
      pEarn.style.width = `${Math.min(100, e/LIMIT_EARN*100)}%`;
      pX1.style.width   = `${Math.min(100, b1/LIMIT_X*100)}%`;
      pX2.style.width   = `${Math.min(100, b2/LIMIT_X*100)}%`;

      // cooldown display
      const n = nowServer();
      setCD(btnEarn, cdEarn, d.lastEarn, e>=LIMIT_EARN, n);
      setCD(btnX1 , cdX1 , d.lastBonus1, b1>=LIMIT_X, n);
      setCD(btnX2 , cdX2 , d.lastBonus2, b2>=LIMIT_X, n);
    });
  }

  function setCD(button, label, lastTime, isMaxed, now){
    if(isMaxed){ button.disabled = true; label.textContent="limit tercapai"; return; }
    const remain = (lastTime||0) + COOLDOWN_MS - now;
    if(remain>0){
      button.disabled = true;
      label.textContent = fmt(remain);
    }else{
      button.disabled = false;
      label.textContent = "siap";
    }
  }
  function fmt(ms){
    const s = Math.ceil(ms/1000);
    const m = Math.floor(s/60), r=s%60;
    return `${m}:${String(r).padStart(2,'0')}`;
  }

  // ==== Reset harian 06:00 ====
  function scheduleDailyReset(uid){
    maybeReset(uid);
    setInterval(()=>maybeReset(uid), 60000);
  }
  async function maybeReset(uid){
    const uRef = ref(db,"users/"+uid);
    const snap = await get(uRef);
    if(!snap.exists()) return;
    const d = snap.val()||{};
    const now = new Date(nowServer());
    const cut = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6,0,0,0);
    const key = cut.toDateString();
    if(d.lastReset !== key && now >= cut){
      await update(uRef, { earnToday:0, bonus1Today:0, bonus2Today:0, lastReset:key });
    }
  }

  // ====== Helpers ======
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed'; t.style.bottom='24px'; t.style.left='50%';
    t.style.transform='translateX(-50%)';
    t.style.background='#12151b'; t.style.border='1px solid #273042';
    t.style.padding='10px 14px'; t.style.borderRadius='12px';
    t.style.color='#fff'; t.style.fontWeight='700'; t.style.zIndex='9999';
    t.style.boxShadow='0 10px 30px rgba(0,0,0,.35)';
    document.body.appendChild(t);
    requestAnimationFrame(()=>{ t.style.opacity='1'; });
    setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; }, 1400);
    setTimeout(()=>{ t.remove(); }, 1800);
  }

  // Promise guard (supaya gak pernah stuck nunggu iklan)
  function withTimeout(promise, ms, onTimeout){
    let timer;
    return Promise.race([
      promise.finally(()=>clearTimeout(timer)),
      new Promise((_, reject)=>{
        timer = setTimeout(()=>{
          onTimeout?.();
          reject(new Error("timeout"));
        }, ms);
      })
    ]);
  }

  // ====== Earning (Monetag Rewarded + popup tiap 5 klik) ======
  let earnClickCount = 0;
  btnEarn.addEventListener('click', async ()=>{
    if(!auth.currentUser) return;

    // Cek limit/cooldown dulu
    const uid = auth.currentUser.uid, uRef = ref(db,"users/"+uid);
    const snap = await get(uRef); if(!snap.exists()) return;
    const d = snap.val()||{}, now = nowServer();
    if((d.earnToday||0) >= LIMIT_EARN){ toast("Limit harian Menghasilkan tercapai"); return; }
    if(now < (d.lastEarn||0) + COOLDOWN_MS){ toast("Masih cooldown"); return; }

    // Cek SDK siap
    if(typeof window.show_9779635 !== "function"){
      toast("Iklan belum siap, coba lagi");
      return;
    }

    // Panggil rewarded + guard timeout
    try{
      await withTimeout(window.show_9779635(), AD_TIMEOUT, ()=>toast("Iklan lambat, batalkan"));
    }catch(e){
      // tidak reward bila gagal/timeout
      return;
    }

    // Update saldo setelah iklan sukses
    const res = await runTransaction(uRef, (v)=>{
      if(!v) return v;
      const now2 = nowServer();
      if((v.earnToday||0)>=LIMIT_EARN) return v;
      if(now2 < (v.lastEarn||0) + COOLDOWN_MS) return v;
      v.balance=(v.balance||0)+REWARD_EARN;
      v.earnToday=(v.earnToday||0)+1;
      v.lastEarn=now2;
      return v;
    });
    if(res.committed){ toast("+ Rp 20.000"); }

    // Popup tiap 5 klik sukses
    earnClickCount++;
    if(earnClickCount % 5 === 0 && typeof window.show_9779635 === "function"){
      // jangan blok UI; popup tidak mempengaruhi reward
      window.show_9779635('pop').catch(()=>{});
    }
  });

  // ====== Xstra Bonus (Adila: 5 banner â†’ +4s inpage â†’ +3s popunder) ======
  btnX1.addEventListener('click', ()=> runBonusFlow('x1', areaX1));
  btnX2.addEventListener('click', ()=> runBonusFlow('x2', areaX2));

  async function runBonusFlow(type, mount){
    if(!auth.currentUser) return;

    const uid = auth.currentUser.uid, uRef = ref(db,"users/"+uid);
    const snap = await get(uRef); if(!snap.exists()) return;
    const d = snap.val()||{}, now = nowServer();

    const isX1 = (type==='x1');
    const today = isX1 ? (d.bonus1Today||0) : (d.bonus2Today||0);
    const last  = isX1 ? (d.lastBonus1||0) : (d.lastBonus2||0);

    if(today >= LIMIT_X){ toast("Limit harian Bonus tercapai"); return; }
    if(now < last + COOLDOWN_MS){ toast("Bonus masih cooldown"); return; }

    // Pastikan adManager siap setelah script load
    if(!window.adManager){
      toast("Iklan belum siap, coba lagi");
      return;
    }

    // Bersihkan area & render 5 banner 300x250
    mount.innerHTML = "";
    const bannerIds = ["1463096","1463097","1463098","1463099","1463100"];
    bannerIds.forEach(id=>{
      const box = document.createElement('div');
      box.className = "bannerBox";
      const el = document.createElement('div');
      el.setAttribute('data-banner-id', id);
      el.style.width = "300px";
      el.style.height= "250px";
      box.appendChild(el);
      mount.appendChild(box);
    });
    try{ window.adManager && window.adManager.render && window.adManager.render(); }catch(e){}

    // 4 detik â†’ inpage
    await new Promise(r=>setTimeout(r, 4000));
    {
      const box = document.createElement('div'); box.className="bannerBox";
      const inpage = document.createElement('div'); inpage.setAttribute('data-banner-id','1463094');
      inpage.style.width="100%"; inpage.style.minHeight="100px";
      box.appendChild(inpage); mount.appendChild(box);
      try{ window.adManager && window.adManager.render(); }catch(e){}
    }

    // +3 detik â†’ popunder
    await new Promise(r=>setTimeout(r, 3000));
    {
      const pop = document.createElement('div');
      pop.setAttribute('data-banner-id','1463095');
      pop.style.width="1px"; pop.style.height="1px"; pop.style.overflow="hidden";
      mount.appendChild(pop);
      try{ window.adManager && window.adManager.render(); }catch(e){}
    }

    // Setelah sequence selesai â†’ kasih reward (transaction & cooldown re-check)
    const res = await runTransaction(uRef, (v)=>{
      if(!v) return v;
      const now2 = nowServer();
      if(isX1){
        if((v.bonus1Today||0) >= LIMIT_X) return v;
        if(now2 < (v.lastBonus1||0) + COOLDOWN_MS) return v;
        v.balance=(v.balance||0)+REWARD_X;
        v.bonus1Today=(v.bonus1Today||0)+1;
        v.lastBonus1=now2;
      }else{
        if((v.bonus2Today||0) >= LIMIT_X) return v;
        if(now2 < (v.lastBonus2||0) + COOLDOWN_MS) return v;
        v.balance=(v.balance||0)+REWARD_X;
        v.bonus2Today=(v.bonus2Today||0)+1;
        v.lastBonus2=now2;
      }
      return v;
    });
    if(res.committed){ toast("+ Rp 10.000"); }
  }

  // ==== Start UI ====
  // tampilkan auth setelah splash
  setTimeout(()=>{ authWrap.style.display = "flex"; }, 300);

</script>
</body>
</html>